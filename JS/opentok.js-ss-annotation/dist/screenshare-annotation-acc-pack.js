(function(){var e,n,t,o={},i=function(e,t){n&&n.triggerEvent(e,t)},r=function(){var e=["startAnnotation","linkAnnotation","resizeCanvas","annotationWindowClosed","endAnnotation"];n.registerEvents(e)},a=function(){var e=['<div id="toolbar"></div>'].join("\n");$("body").append(e)},s=[{id:"OT_pen",title:"Pen",icon:"../images/annotation/freehand.png",selectedIcon:"../images/annotation/freehand_selected.png"},{id:"OT_line",title:"Line",icon:"../images/annotation/line.png",selectedIcon:"../images/annotation/line_selected.png"},{id:"OT_text",title:"Text",icon:"../images/annotation/text.png",selectedIcon:"../images/annotation/text.png"},{id:"OT_shapes",title:"Shapes",icon:"../images/annotation/shapes.png",items:[{id:"OT_arrow",title:"Arrow",icon:"../images/annotation/arrow.png"},{id:"OT_rect",title:"Rectangle",icon:"../images/annotation/rectangle.png"},{id:"OT_oval",title:"Oval",icon:"../images/annotation/oval.png"},{id:"OT_star",title:"Star",icon:"../images/annotation/star.png",points:[[.5+.5*Math.cos(90*(Math.PI/180)),.5+.5*Math.sin(90*(Math.PI/180))],[.5+.25*Math.cos(126*(Math.PI/180)),.5+.25*Math.sin(126*(Math.PI/180))],[.5+.5*Math.cos(162*(Math.PI/180)),.5+.5*Math.sin(162*(Math.PI/180))],[.5+.25*Math.cos(198*(Math.PI/180)),.5+.25*Math.sin(198*(Math.PI/180))],[.5+.5*Math.cos(234*(Math.PI/180)),.5+.5*Math.sin(234*(Math.PI/180))],[.5+.25*Math.cos(270*(Math.PI/180)),.5+.25*Math.sin(270*(Math.PI/180))],[.5+.5*Math.cos(306*(Math.PI/180)),.5+.5*Math.sin(306*(Math.PI/180))],[.5+.25*Math.cos(342*(Math.PI/180)),.5+.25*Math.sin(342*(Math.PI/180))],[.5+.5*Math.cos(18*(Math.PI/180)),.5+.5*Math.sin(18*(Math.PI/180))],[.5+.25*Math.cos(54*(Math.PI/180)),.5+.25*Math.sin(54*(Math.PI/180))],[.5+.5*Math.cos(90*(Math.PI/180)),.5+.5*Math.sin(90*(Math.PI/180))]]}]},{id:"OT_colors",title:"Colors",icon:"",items:{}},{id:"OT_line_width",title:"Line Width",icon:"../images/annotation/line_width.png",items:{}},{id:"OT_clear",title:"Clear",icon:"../images/annotation/clear.png"}],c=["#1abc9c","#2ecc71","#3498db","#9b59b6","#8e44ad","#f1c40f","#e67e22","#e74c3c","#ded5d5"],l=10/6,d=_.throttle(function(){t.onResize()},1e3),u=function(){var e,n;if(o.externalWindow){var t={width:o.externalWindow.innerWidth,height:o.externalWindow.innerHeight},r=t.width/l;r<=t.height?(e=t.width,n=r):(n=t.height,e=n*l)}else{var a=o.absoluteParent||o.canvasContainer;e=$(a).width(),n=$(a).height()}$(o.canvasContainer).css({width:e,height:n}),$(o.canvas).css({width:e,height:n}),$(o.canvas).attr({width:e,height:n}),d(),i("resizeCanvas")},h=function(){$(o.resizeSubject).on("resize",_.throttle(function(){u()},500))},p=function(e,n,t){var o=_.property("toolbarId")(n)||"toolbar",i=_.property("toolbarItems")(n)||s,r=_.property("colors")(n)||c,a=function(){var e=t?t:window;return e.document.getElementById(o)};toolbar=new OTSolution.Annotations.Toolbar({session:e,container:a(),colors:r,items:i,externalWindow:t||null})},f=function(){var e=$.Deferred(),n=.8*screen.width|0,t=n/l,o=["templates/screenshare.html?opentok-annotation"].join(""),r=["toolbar=no","location=no","directories=no","status=no","menubar=no","scrollbars=no","resizable=no","copyhistory=no",["width=",n].join(""),["height=",t].join(""),["left=",screen.width/2-n/2].join(""),["top=",screen.height/2-t/2].join("")].join(","),a=window.open(o,"",r);window.onbeforeunload=function(){a.close()},a.toolbar=toolbar,a.OT=OT,a.$=$,a.triggerCloseEvent=function(){i("annotationWindowClosed")};var s=function(){a.createContainerElements?$(a.document).ready(function(){e.resolve(a)}):setTimeout(s,100)};return s(),e.promise()},g=function(){$(o.resizeSubject).off("resize",u),toolbar.remove()},m=function(e,n){var t=$.Deferred();return _.property("screensharing")(n)?f().then(function(o){p(e,n,o),toolbar.createPanel(o),i("startAnnotation",o),t.resolve(o)}):(p(e,n),i("startAnnotation"),t.resolve()),t.promise()},b=function(e,n,r){o.resizeSubject=_.property("externalWindow")(r)||window,o.externalWindow=_.property("externalWindow")(r)||null,o.absoluteParent=_.property("absoluteParent")(r)||null,o.canvasContainer=n,t=new OTSolution.Annotations({feed:e,container:n,externalWindow:o.externalWindow}),toolbar.addCanvas(t),t.onScreenCapture(function(e){var n=window.open(e,"_blank");n.focus()});var a=o.externalWindow?o.externalWindow:window;o.canvas=$(_.first(a.document.getElementsByTagName("canvas"))),h(),u(),i("linkAnnotation")},v=function(){u()},w=function(){g(),o.canvas=null,o.externalWindow&&(o.externalWindow.close(),o.externalWindow=null,o.resizeSubject=null),i("endAnnotation")},S=function(t){e=this,e.options=_.omit(t,"accPack"),n=_.property("accPack")(t),r(),a()};S.prototype={constructor:S,start:m,linkCanvas:b,resizeCanvas:v,end:w},"object"==typeof exports?module.exports=S:"function"==typeof define&&define.amd?define(function(){return S}):this.AnnotationAccPack=S}).call(this),function(){var e,n,t,o,i=function(){if(t){var e=["startCall","endCall","callPropertyChanged","startViewingSharedScreen","endViewingSharedScreen"];t.registerEvents(e)}},r=function(e,n){t&&t.triggerEvent(e,n)},a={clientVersion:"js-vsol-1.0.0",source:"avcommunication_acc_pack",actionInitialize:"initialize",actionStartComm:"start",actionStopComm:"stop",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},s=function(e,n){var t={action:e,variation:n};o.logEvent(t)},c=function(){var t={sessionId:e.options.sessionId,connectionId:n.id,partnerId:n.apiKey,clientVersion:a.clientVersion,source:a.source};o=new OTKAnalytics(t)},l=function(){var n=e.options.localCallProperties;e.options.user&&(n.name=e.options.user.name),e.publisher=OT.initPublisher("videoHolderSmall",n,function(e){e&&console.log("Error starting a call",e)})},d=function(){return l(),n.publish(e.publisher,function(e){if(e){console.log(["Error starting a call",e.code,"-",e.message].join(""));var n;n=1010===e.code?[e.message,". Check your network connection."].join(""):e.message,console.log(e,n),s(a.actionStartComm,a.variationError)}})},u=function(){e.publisher&&n.unpublish(e.publisher)},h=function(){_.each(e.streams,function(e){n.unsubscribe(e)})},p=function(t){var o;o="screen"===t.videoType?e.options.localScreenProperties:e.options.localCallProperties;var i;i="screen"===t.videoType?"videoHolderSharedScreen":"videoHolderBig";var a=n.subscribe(t,i,o,function(n){if(n){var o=1010===n.code?"Check your network connection.":"";console.log(n,o)}else e.streams.push(a),"screen"===t.videoType&&r("startViewingSharedScreen",a)});e.subscriber=a},f=function(e){return e},g=function(e){return e},m=function(n){e.subscribers.push(n.stream),e._remoteParticipant=n.connection,p(n.stream)},b=function(n){console.log("Participant left the call");var t=n.stream.videoType,o=e.subscribers.indexOf(n.stream);e.subscribers.splice(o,1),"camera"===t?(e.subscriber=null,e._remoteParticipant=null):"screen"===t?r("endViewingSharedScreen"):_.each(e.subscribers,function(e){p(e)})},v=function(e){var n;n="hasAudio"===e.changedProperty?{property:"Audio",enabled:e.newValue}:{property:"Video",enabled:e.newValue},r("callPropertyChanged",n)},w=function(){t?(t.registerEventListener("streamCreated",m),t.registerEventListener("streamDestroyed",b)):(n.on("streamCreated",m),n.on("streamDestroyed",b))},S=function(e,n){if(!e||!e.session)throw new Error("No session provided.");return _.defaults(_.omit(e,n))},y=function(o){e=this;var r=["subscribers","streams"];e.options=S(o,r),_.extend(e,_.defaults(_.pick(o,r),{subscribers:[],streams:[]})),n=_.property("session")(o),t=_.property("accPack")(o),i(),w(),c(),s(a.actionInitialize,a.variationAttempt),s(a.actionInitialize,a.variationSuccess)};y.prototype={constructor:y,start:function(){s(a.actionStartComm,a.variationAttempt),e.options.inSession=!0,e.publisher=d("camera"),$.when(e.publisher.on("streamCreated")).done(function(e){f(e)}).promise(),e.publisher.on("streamDestroyed",function(e){console.log("stream destroyed"),g(e)}),e.publisher.session.on("streamPropertyChanged",function(n){e.publisher.stream===n.stream&&v(n)}),_.each(e.subscribers,function(e){p(e)}),r("startCall"),s(a.actionStartComm,a.variationSuccess)},end:function(){s(a.actionStopComm,a.variationAttempt),e.options.inSession=!1,u("camera"),h(),r("endCall"),s(a.actionStopComm,a.variationSuccess)},enableLocalAudio:function(n){e.publisher.publishAudio(n)},enableLocalVideo:function(n){e.publisher.publishVideo(n)},enableRemoteVideo:function(n){e.subscriber.subscribeToVideo(n)},enableRemoteAudio:function(n){e.subscriber.subscribeToAudio(n)}},"object"==typeof exports?module.exports=y:"function"==typeof define&&define.amd?define(function(){return y}):this.CommunicationAccPack=y}.call(this),function(){var e,n,t,o,i=['<div class="video-control circle share-screen" id="startScreenSharing"></div>'].join("\n"),r=['<div class="hidden" id="screenShareView">','<div class="wms-feed-main-video">','<div class="wms-feed-holder" id="videoHolderScreenShare"></div>','<div class="wms-feed-mask"></div>','<img src="/images/mask/video-mask.png"/>',"</div>",'<div class="wms-feed-call-controls" id="feedControlsFromScreen">','<button class="wms-icon-screen active hidden" id="endScreenShareBtn"></button>',"</div>","</div>"].join("\n"),a=['<div id="dialog-form-chrome" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Chrome extension to share your screen. Install Screensharing Extension. Once you have installed, please, click the share screen button again.</p>",'<button id="btn-install-plugin-chrome" class="wms-btn-install">Accept</button>','<button id="btn-cancel-plugin-chrome" class="wms-cancel-btn-install"></button>',"</div>","</div>",'<div id="dialog-form-ff" class="wms-modal" style="display: none;">','<div class="wms-modal-body">','<div class="wms-modal-title with-icon">','<i class="wms-icon-share-large"></i>',"<span>Screen Share<br/>Extension Installation</span>","</div>","<p>You need a Firefox extension to share your screen. Install Screensharing Extension. Once you have installed, refresh your browser and click the share screen button again.</p>",'<a href="#" id="btn-install-plugin-ff" class="wms-btn-install" href="">Install extension</a>','<a href="#" id="btn-cancel-plugin-ff" class="wms-cancel-btn-install"></a>',"</div>","</div>"].join("\n"),s=function(n){$("body").append(a),$(e._screenSharingControls).append(i),$(n).append(r)},c=function(e){$("#startScreenSharing")[e?"show":"hide"]()},l=function(e,n){t&&t.triggerEvent(e,n)},d=function(){var n=function(n){var t=$.Deferred(),o=n||$("#videoHolderScreenShare");return e.publisher=OT.initPublisher(o,e.localScreenProperties,function(e){e?(l("screenSharingError",e),t.reject(_.extend(_.omit(e,"messsage"),{message:"Error starting the screen sharing"}))):t.resolve()}),t.promise()},o=$.Deferred();return e.annotation?t.setupExternalAnnotation().then(function(t){e.annotationWindow=t||null;var i=t.createContainerElements();n(i.publisher).then(function(){o.resolve(i.annotation)})}):n().then(function(){o.resolve()}),o.promise()},u=function(i){o.publish(e.publisher,function(o){if(o){var r=_.omit(o,"message");if(1500===o.code&&-1!==navigator.userAgent.indexOf("Firefox"))$("#dialog-form-ff").toggle();else{var a;a=1010===o.code?"Check your network connection":"Error sharing the screen",r.message=a,l("screenSharingError",r)}}else e.annotation&&t.linkAnnotation(e.publisher,i,e.annotationWindow),n=!0,l("startScreenSharing")})},h=function(){o.unpublish(e.publisher),e.publisher=null},p=function(){var e=$.Deferred();return"http:"===window.location.protocol&&(alert("Screensharing only works under 'https', please add 'https://' in front of your debugger url."),e.reject("https required")),OT.checkScreenSharingCapability(function(n){console.log("checkScreenSharingCapability",n),n.supported&&n.extensionRegistered?n.extensionInstalled?e.resolve():($("#dialog-form-chrome").toggle(),e.reject("screensharing extension not installed")):(alert("This browser does not support screen sharing! Please use Chrome, Firefox or IE!"),e.reject("browser support not available"))}),e.promise()},f=function(){p(e.extensionID,e.extensionPathFF).then(d).then(u).fail(function(e){console.log("Error starting screensharing: ",e)})},g=function(e){h(),n=!1,e&&c(!1),l("endScreenSharing")},m=function(){if(t){var e=["startScreenSharing","endScreenSharing","screenSharingError"];t.registerEvents(e)}},b=function(){var o=_.throttle(function(){n?g():f()},750);$("#startScreenSharing").on("click",o),$("#btn-install-plugin-chrome").on("click",function(){chrome.webstore.install(["https://chrome.google.com/webstore/detail/",e.extensionID].join(""),function(e){console.log("success",e)},function(e){console.log("error",e)}),$("#dialog-form-chrome").toggle()}),$("#btn-cancel-plugin-chrome").on("click",function(){$("#dialog-form-chrome").toggle()}),$("#btn-install-plugin-ff").prop("href",e.extensionPathFF),$("#btn-install-plugin-ff").on("click",function(){$("#dialog-form-ff").toggle()}),$("#btn-cancel-plugin-ff").on("click",function(){$("#dialog-form-ff").toggle()}),t&&(t.registerEventListener("startCall",function(){c(!0)}),t.registerEventListener("endCall",function(){n?g(!0):c(!1)}),t.registerEventListener("annotationWindowClosed",function(){g()}))},v=function(e,n){if("Chrome"===OT.$.browser()){if(!e||!e.length)throw new Error("Error starting the screensharing. Chrome extensionID required");$("<link/>",{rel:"chrome-webstore-item",href:["https://chrome.google.com/webstore/detail/",e].join("")}).appendTo("head"),OT.registerScreenSharingExtension("chrome",e,2)}if(!("Firefox"!==OT.$.browser()||n&&n.length))throw new Error("Error starting the screensharing. Firefox screensharing extension required")},w=function(e){if(!_.property("session",e))throw new Error("Screen Share Acc Pack requires an OpenTok session");o=_.property("session")(e),t=_.property("accPack")(e),v(_.property("extensionID")(e),_.property("extensionPathFF")(e))},S=function(n){e=this,w(n);var t=["annotation","extensionURL","extensionID","extensionPathFF","screensharingParent","localScreenProperties"];_.extend(e,_.defaults(_.pick(n,t)),{screenSharingParent:"#videoContainer",_screenSharingControls:"#feedControls"}),s(e.screensharingParent),m(),b()};S.prototype={constructor:S,extensionAvailable:p,start:f,end:g},"object"==typeof exports?module.exports=S:"function"==typeof define&&define.amd?define(function(){return S}):this.ScreenSharingAccPack=S}.call(this);
